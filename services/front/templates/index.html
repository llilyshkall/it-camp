<!doctype html>
<html lang="ru" data-theme="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ page_title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<a class="skip-link" href="#main">–ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é</a>

<header>
  <div class="header-top">
    <div class="container">
      <div class="brand">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–µ–∫—Ç</div>
      <nav class="meta-nav" aria-label="–°–ª—É–∂–µ–±–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
        <button id="theme-toggle" class="icon-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
        <a href="#top">–ü–æ–º–æ—â—å</a>
        <a href="#top" lang="ru">RU</a>
      </nav>
    </div>
  </div>

  <div class="main-nav-wrapper">
    <div class="container header-row">
      <div class="wordmark"><a class="wordmark-link" href="#top">–ü–†–û–ï–ö–¢ –î–õ–Ø –ì–ê–ó–ü–†–û–ú–ê</a></div>
      <nav class="main-nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
        <a href="#top" data-target="#top" class="nav-link" aria-current="page">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#assurance-card" data-target="#assurance-card" class="nav-link">–ß–µ–∫-–ª–∏—Å—Ç</a>
        <a href="#remarks-card" data-target="#remarks-card" class="nav-link">–ó–∞–º–µ—á–∞–Ω–∏—è</a>
        <a href="#protocol-card" data-target="#protocol-card" class="nav-link">–ü—Ä–æ—Ç–æ–∫–æ–ª</a>
      </nav>
    </div>
  </div>
</header>

<main id="main">
  <span id="top" class="anchor-offset" aria-hidden="true"></span>

  <!-- HERO –±–µ–∑ –∫–Ω–æ–ø–æ–∫ -->
  <section class="hero">
    <div class="container">
      <h1>–ß–∏—Å—Ç–∞—è —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>
      <p class="lead">–ó–∞–≥–ª—É—à–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å —ç—Å—Ç–µ—Ç–∏–∫–æ–π ¬´—Å–∏–Ω–µ-–±–µ–ª–æ–≥–æ¬ª –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç–∏–ª—è. –ë–µ–∑ –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –∏ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤. –ì–æ—Ç–æ–≤–æ –∫ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—é.</p>
    </div>
  </section>

  <!-- –®–∞–≥–∏ -->
  <section class="steps">
    <div class="container">
      <ol class="steps-grid" aria-label="–≠—Ç–∞–ø—ã –ø—Ä–æ—Ü–µ—Å—Å–∞">
        <li class="step" data-target="#assurance-card"><div class="step-num">1</div><div class="step-body"><div class="step-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É</div><div class="step-desc">–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∞—à—É—Ä–∞–Ω—Å–∞.</div></div></li>
        <li class="step" data-target="#remarks-card"><div class="step-num">2</div><div class="step-body"><div class="step-title">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ—á–∞–Ω–∏–π</div><div class="step-desc">–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Excel –∏ –≤—ã–≥—Ä—É–∑–∫–∞.</div></div></li>
        <li class="step" data-target="#protocol-card"><div class="step-num">3</div><div class="step-body"><div class="step-title">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</div><div class="step-desc">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.</div></div></li>
      </ol>
    </div>
  </section>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <section class="section">
    <div class="container">
      <div class="stack">

        <!-- 1) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É -->
        <div class="card card-lg" id="assurance-card">
          <div class="card-head">
            <div class="card-icon" aria-hidden="true">‚úÖ</div>
            <h3>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É –¥–ª—è –∞—à—É—Ä–∞–Ω—Å–∞</h3>
          </div>
          <p class="sublead">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã. –î–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã: <strong>PDF, DOC(X), XLS(X), CSV, TXT</strong>. –î–æ <strong>25&nbsp;–ú–ë</strong> —Å—É–º–º–∞—Ä–Ω–æ.</p>

          <div id="dropzone" class="dropzone" aria-label="–ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤" tabindex="0">
            <input id="file-input" type="file" name="files[]" multiple aria-hidden="true" />
            <div class="dz-in">
              <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</strong>
              <span class="dz-sep">–∏–ª–∏</span>
              <button type="button" id="pick-btn" class="btn btn-ghost">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
            </div>
          </div>

          <div id="upload-info" class="upload-info" hidden></div>

          <div id="assurance-result" class="assurance-result" hidden>
            <span id="verdict-badge" class="badge">‚Äî</span>
            <ul id="verdict-reasons" class="reasons"></ul>
          </div>

          <div class="actions actions--spaced">
            <button class="btn btn-primary" id="download-assurance" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫-–ª–∏—Å—Ç</button>
          </div>
        </div>

        <!-- 2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ—á–∞–Ω–∏–π -->
        <div class="card card-lg" id="remarks-card">
          <div class="card-head">
            <div class="card-icon" aria-hidden="true">üßæ</div>
            <h3>–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
          </div>
          <p class="sublead">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Å –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ—Å–ª–µ –∞—à—É—Ä–∞–Ω—Å–∞ (<strong>.xls/.xlsx</strong>). –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º ¬´–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –∑–∞–º–µ—á–∞–Ω–∏–π¬ª.</p>

          <div id="remarks-zone" class="dropzone" aria-label="–§–∞–π–ª –∑–∞–º–µ—á–∞–Ω–∏–π" tabindex="0">
            <input id="remarks-input" type="file" name="remarks" accept=".xls,.xlsx" aria-hidden="true" />
            <div class="dz-in">
              <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Å—é–¥–∞</strong>
              <span class="dz-sep">–∏–ª–∏</span>
              <button type="button" id="remarks-pick" class="btn btn-ghost">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            </div>
          </div>

          <div id="remarks-info" class="upload-info" hidden></div>

          <div class="actions actions--spaced">
            <button class="btn btn-primary" id="download-remarks" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–µ—Å—Ç—Ä –∑–∞–º–µ—á–∞–Ω–∏–π</button>
          </div>
        </div>

        <!-- 3) –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ -->
        <div class="card card-lg" id="protocol-card">
          <div class="card-head">
            <div class="card-icon" aria-hidden="true">üìÑ</div>
            <h3>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞</h3>
          </div>
          <p class="sublead">–ù–∞–∂–º–∏—Ç–µ ¬´–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å¬ª, –∏ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç  —Ñ–∞–π–ª –ø—Ä–æ—Ç–æ–∫–æ–ª–∞.</p>
          <div class="actions">
            <button class="btn btn-primary" id="make-protocol">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<footer class="footer">
  <div class="container">
    <div>
      <div class="wordmark-sm">–ü—Ä–æ–µ–∫—Ç –¥–ª—è –ì–∞–∑–ø—Ä–æ–º–∞</div>
      <small>–î–µ–º–æ-—Å—Ç–∏–ª—å –±–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —Å–∏–º–≤–æ–ª–∏–∫–∏.</small>
    </div>
    <nav class="footer-nav" aria-label="–í—Ç–æ—Ä–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
      <a href="#top">–ü–æ–ª–∏—Ç–∏–∫–∞</a>
      <a href="#top">–£—Å–ª–æ–≤–∏—è</a>
      <a href="#top">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
    </nav>
  </div>
</footer>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden>
  <div id="toast-msg"></div>
</div>

<script>
  // ===== –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (auto ‚Üí light ‚Üí dark) =====
  (function(){
    const root = document.documentElement;
    const btn = document.getElementById('theme-toggle');
    const apply = (mode) => {
      if (!mode) { root.removeAttribute('data-theme'); btn.textContent='üåô'; return; }
      root.setAttribute('data-theme', mode);
      btn.textContent = mode === 'light' ? 'üåû' : 'üåô';
    };
    const saved = localStorage.getItem('theme');
    apply(saved);
    btn.addEventListener('click', () => {
      const current = root.getAttribute('data-theme');
      let next;
      if (!current) next = 'light';
      else if (current === 'light') next = 'dark';
      else next = null;
      if (next) localStorage.setItem('theme', next); else localStorage.removeItem('theme');
      apply(next);
    });
  })();

  // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
  function scrollToTarget(sel){const el=document.querySelector(sel); if(el) el.scrollIntoView({behavior:'smooth',block:'start'});}

  // –°–∂–∞—Ç–∏–µ —à–∞–ø–∫–∏
  document.addEventListener('scroll',()=>{const w=document.querySelector('.main-nav-wrapper'); if(w) w.classList.toggle('compact',window.scrollY>16);},{passive:true});

  // –ú–µ–Ω—é –∏ ¬´–°—Ç—É–ø–µ–Ω–∏¬ª
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{e.preventDefault(); scrollToTarget(a.getAttribute('data-target')||a.getAttribute('href'));});
  });
  document.querySelectorAll('.steps .step').forEach(s=>{
    s.addEventListener('click',()=> scrollToTarget(s.getAttribute('data-target')));
  });

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –∏ —à–∞–≥–∞
  const anchors=['#top','#assurance-card','#remarks-card','#protocol-card'].map(s=>document.querySelector(s)).filter(Boolean);
  const nav=[...document.querySelectorAll('.nav-link')];
  const steps=[...document.querySelectorAll('.steps .step')];
  const isInView=(el)=>{const r=el.getBoundingClientRect(); return r.top<=140 && r.bottom>=140;};
  const updateActive=()=>{
    for(const s of anchors){
      if(isInView(s)){
        const id='#'+(s.id||'top');
        nav.forEach(a=>a.toggleAttribute('aria-current',(a.getAttribute('data-target')===id)||(a.getAttribute('href')===id)));
        steps.forEach(st=>st.classList.toggle('active', st.getAttribute('data-target')===id));
        break;
      }
    }
  };
  updateActive(); document.addEventListener('scroll',()=>requestAnimationFrame(updateActive),{passive:true});

  // –¢–æ—Å—Ç
  function toast(msg, ok=true){
    const el=document.getElementById('toast'); const text=document.getElementById('toast-msg');
    text.textContent=msg; el.classList.toggle('bad', !ok); el.hidden=false; el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'), 2400);
  }

  // ===== 1) –ê—à—É—Ä–µ–Ω—Å =====
  (()=>{const dz=document.getElementById('dropzone'); const input=document.getElementById('file-input');
    const pickBtn=document.getElementById('pick-btn'); const info=document.getElementById('upload-info');
    const res=document.getElementById('assurance-result'); const badge=document.getElementById('verdict-badge');
    const reasonsUl=document.getElementById('verdict-reasons'); const downloadBtn=document.getElementById('download-assurance');
    let lastAssurance=null;

    const stop=(e)=>{e.preventDefault(); e.stopPropagation();};
    const showFiles=(files)=>{const list=Array.from(files).map(f=>`${f.name} ‚Äî ${(f.size/1024).toFixed(1)} –ö–ë`).join('<br>'); info.innerHTML=list||'–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã'; info.hidden=false;};
    const send=async(files)=>{const fd=new FormData(); Array.from(files).forEach(f=>fd.append('files[]',f,f.name)); const r=await fetch('/assurance',{method:'POST',body:fd}); if(!r.ok) throw 0; return await r.json();}
    const apply=(data)=>{lastAssurance=data; downloadBtn.disabled=false; badge.textContent=data.title||'‚Äî'; badge.classList.remove('ok','fail'); badge.classList.add(data.verdict==='ok'?'ok':'fail'); reasonsUl.innerHTML=''; (data.reasons||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; reasonsUl.appendChild(li);}); res.hidden=false; toast(data.title, data.verdict==='ok');};

    pickBtn.addEventListener('click',()=>input.click());
    // input.addEventListener('change',async()=>{const files=input.files; if(!files?.length) return; showFiles(files); try{apply(await send(files));}catch{toast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',false); badge.textContent='–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏'; badge.classList.remove('ok'); badge.classList.add('fail'); reasonsUl.innerHTML='<li>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</li>'; res.hidden=false; }});
    input.addEventListener('change', async () => {
      const files = input.files;
      if (!files?.length) return;

      showFiles(files);
      try {
        const response = await send(files);
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ send –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏
        await apply(response);
      } catch (error) {
        // –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –ø—Ä–∏—á–∏–Ω–æ–π –æ—à–∏–±–∫–∏
        let reasonText = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
        if (error instanceof Response) {
          try {
            const errorData = await error.json();
            reasonText = errorData.reasons ? errorData.reasons.join(', ') : reasonText;
          } catch (_) {
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
          }
        }
        toast(reasonText, false);
        badge.textContent = reasonText;
        badge.classList.remove('ok');
        badge.classList.add('fail');
        reasonsUl.innerHTML = '';
        if (error instanceof Response && error.status === 400) {
          try {
            const errorData = await error.json();
            if (errorData.reasons) {
              reasonsUl.innerHTML = errorData.reasons.map(reason => `<li>${reason}</li>`).join('');
            }
          } catch (_) {}
        } else {
          reasonsUl.innerHTML = '<li>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</li>';
        }
        res.hidden = false;
      }
    });

    ['dragenter','dragover','dragleave','drop'].forEach(ev=>dz.addEventListener(ev,stop,false));
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.add('hover'),false));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,()=>dz.classList.remove('hover'),false));
    dz.addEventListener('drop',async(e)=>{const files=e.dataTransfer.files; if(!files?.length) return; showFiles(files); try{apply(await send(files));}catch{toast('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',false); badge.textContent='–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏'; badge.classList.remove('ok'); badge.classList.add('fail'); reasonsUl.innerHTML='<li>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º</li>'; res.hidden=false; }});
    dz.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault(); input.click();}});

    // // –°–∫–∞—á–∞—Ç—å TXT-–æ—Ç—á—ë—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
    // downloadBtn.addEventListener('click', () => {
    //   if (!lastAssurance) return;
    //   const lines = [
    //     '–ü–†–û–í–ï–†–ö–ê –ü–û –ß–ï–ö-–õ–ò–°–¢–£',
    //     '======================',
    //     `–í–µ—Ä–¥–∏–∫—Ç: ${lastAssurance.title || ''}`,
    //     '',
    //     '–ü–æ—è—Å–Ω–µ–Ω–∏—è:',
    //     ...(lastAssurance.reasons || []).map((r,i)=>`${i+1}. ${r}`)
    //   ];
    //   const blob = new Blob([lines.join('\r\n')], {type: 'text/plain;charset=utf-8'});
    //   const url = URL.createObjectURL(blob);
    //   const a = document.createElement('a');
    //   a.href = url; a.download = 'assurance_report.txt';
    //   document.body.appendChild(a); a.click(); a.remove();
    //   URL.revokeObjectURL(url);
    //   toast('–û—Ç—á—ë—Ç –ø–æ —á–µ–∫-–ª–∏—Å—Ç—É —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    // });
      downloadBtn.disabled=false;
      downloadBtn.addEventListener('click', async () => {
      try {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          downloadBtn.disabled = true;
          downloadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          const response = await fetch('http://127.0.0.1:8081/api/file', {
              method: 'GET',
              headers: {
                  'Accept': 'application/octet-stream'
              }
          });
          
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
          const contentDisposition = response.headers.get('Content-Disposition');
          let filename = 'report.xlsx'; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é  
          if (contentDisposition) {
              const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
              if (filenameMatch) filename = filenameMatch[1];
          }
          
          // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ –æ—Ç–≤–µ—Ç–∞  
          const blob = await response.blob();
          
          // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          
          // –û—á–∏—Å—Ç–∫–∞
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
      } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª');
      } finally {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
          downloadBtn.disabled = false;
          downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç';
      }
    });
  })();

  // ===== 2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–º–µ—á–∞–Ω–∏–π =====
  (()=>{const zone=document.getElementById('remarks-zone'); const input=document.getElementById('remarks-input');
    const pick=document.getElementById('remarks-pick'); const info=document.getElementById('remarks-info');
    const btn=document.getElementById('download-remarks'); const stop=(e)=>{e.preventDefault(); e.stopPropagation();};
    const show=(file)=>{info.textContent=`${file.name} ‚Äî ${(file.size/1024).toFixed(1)} –ö–ë`; info.hidden=false; btn.disabled=false;};
    //const stop=(e)=>{e.preventDefault(); e.stopPropagation();};
    //const showFiles=(files)=>{const list=Array.from(files).map(f=>`${f.name} ‚Äî ${(f.size/1024).toFixed(1)} –ö–ë`).join('<br>'); info.innerHTML=list||'–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã'; info.hidden=false;};
    //const send=async(files)=>{const fd=new FormData(); Array.from(files).forEach(f=>fd.append('files[]',f,f.name)); const r=await fetch('/assurance',{method:'POST',body:fd}); if(!r.ok) throw 0; return await r.json();}
    //const apply=(data)=>{lastAssurance=data; downloadBtn.disabled=false; badge.textContent=data.title||'‚Äî'; badge.classList.remove('ok','fail'); badge.classList.add(data.verdict==='ok'?'ok':'fail'); reasonsUl.innerHTML=''; (data.reasons||[]).forEach(t=>{const li=document.createElement('li'); li.textContent=t; reasonsUl.appendChild(li);}); res.hidden=false; toast(data.title, data.verdict==='ok');};
    pick.addEventListener('click',()=>input.click());
    //input.addEventListener('change',()=>{if(!input.files?.[0]) return; show(input.files[0]);});
    input.addEventListener('change', async () => {
      const files = input.files;
      if (!files?.length) return;
      show(files);
    });
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>zone.addEventListener(ev,stop,false));
    ['dragenter','dragover'].forEach(ev=>zone.addEventListener(ev,()=>zone.classList.add('hover'),false));
    ['dragleave','drop'].forEach(ev=>zone.addEventListener(ev,()=>zone.classList.remove('hover'),false));
    zone.addEventListener('drop',(e)=>{const file=e.dataTransfer.files?.[0]; if(!file) return; input.files=e.dataTransfer.files; show(file);});
    zone.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault(); input.click();}});
    // btn.addEventListener('click',async()=>{if(!input.files?.[0]) return; const fd=new FormData(); fd.append('remarks',input.files[0],input.files[0].name);
    //   const r=await fetch('/remarks',{method:'POST',body:fd}); if(!r.ok){toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª (.xls/.xlsx)',false); return;}
    //   const blob=await r.blob(); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='remarks_processed.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('–†–µ–µ—Å—Ç—Ä –∑–∞–º–µ—á–∞–Ω–∏–π —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');});
    btn.disabled=false;
    btn.addEventListener('click', async () => {
      console.log('1123123')
      if (!input.files?.[0]) return;
        file = input.files?.[0];
        const formData = new FormData();
        formData.append('file', file); 
    // –í–∞–∂–Ω–æ: –ø–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä 'file' –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä
    // –í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä - —Å–∞–º —Ñ–∞–π–ª, —Ç—Ä–µ—Ç–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –∏–º—è —Ñ–∞–π–ª–∞
    //fd.append('file', input.files[0], input.files[0].name);
    
    try {
        let url = "http://127.0.0.1:8081/api/attach?type=excel";
        const r = await fetch(url, {
            method: 'POST',
            body: formData,
            // –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å Content-Type –¥–ª—è FormData!
            // –ë—Ä–∞—É–∑–µ—Ä —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º boundary
        });
        
        if (!r.ok) {
            const error = await r.text();
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
            toast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª: ' + error, false);
            return;
        }
          // url = f"http://127.0.0.1:8080/api/attach?type=excel"
          // file = request.files.get('remarks')
          // if not file or not file.filename:
          //     print('–§–∞–π–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω')
          //     return jsonify({'error': '–§–∞–π–ª –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω'}), 400

          // # file_path = '–ø—É—Ç—å_–∫_–≤–∞—à–µ–º—É_—Ñ–∞–π–ª—É.xlsx'

          // # with open(file_path, 'rb') as f:
          // #     files = {'remarks': f}
          // #response = requests.post('http://–≤–∞—à_—Å–µ—Ä–≤–µ—Ä/remarks', files=file)


          // try:
          //     #data = process_remarks_excel(file)
          //     response = requests.post(url, files=file)
          // except Exception as e:
          //     return jsonify({'error': f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª: {e}'}), 400
          // if response.status_code == 200:
          //     #with open('remarks_processed.xlsx', 'wb') as out_file:
          //         #out_file.write(response.content)
          //     print("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.")
          // else:
          //     print(f"–û—à–∏–±–∫–∞: {response.json().get('error')}")
          
          // // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞)
          // const blob = await r.blob();
          // const url = window.URL.createObjectURL(blob);
          // const a = document.createElement('a');
          // a.href = url;
          // a.download = 'processed_' + input.files[0].name;
          // document.body.appendChild(a);
          // a.click();
          // a.remove();
          
      } catch (error) {
          toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', false);
          console.error(error);
      }
  });
  })();

  // ===== 3) –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ =====
  (()=>{const btn=document.getElementById('make-protocol');
    btn.addEventListener('click',async()=>{const r=await fetch('/protocol',{method:'POST'}); if(!r.ok){toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª',false); return;}
      const blob=await r.blob(); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='protocol.docx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('–ü—Ä–æ—Ç–æ–∫–æ–ª –≥–æ—Ç–æ–≤');});
  })();
</script>
</body>
</html>
